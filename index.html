<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¶²é è¡—æ©Ÿæ¨¡æ“¬å™¨ (Web Arcade)</title>
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œæ¨£å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@400;700&display=swap');

        :root {
            /* å®šç¾©å®‰å…¨å€åŸŸè®Šæ•¸ï¼Œé©é… iPhone ç€æµ· */
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
            --sar: env(safe-area-inset-right);
        }

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden; 
            background-image: 
                radial-gradient(#1f1f1f 15%, transparent 16%),
                radial-gradient(#1f1f1f 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        .arcade-screen-container {
            background: #000;
            box-shadow: 
                0 0 15px rgba(0, 0, 0, 0.9),
                inset 0 0 30px rgba(0,0,0,0.6);
            border: 4px solid #333;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            width: 100%;
            aspect-ratio: 16 / 9; 
            z-index: 10;
            /* éŠæˆ²å€åŸŸå…§ç¦æ­¢é¸å–èˆ‡é è¨­è§¸æ§è¡Œç‚ºï¼Œç¢ºä¿æ–æ¡¿é †æš¢ */
            -webkit-user-select: none;
            user-select: none;
            touch-action: none; 
        }

        /* === å…¨è¢å¹•é€šç”¨æ¨£å¼ (æ‰‹å‹• & è‡ªå‹•æ©«å±å…±ç”¨) === */
        /* ä½¿ç”¨ fixed + å››é‚Šæ­¸é›¶ï¼Œé”åˆ°åƒå½±ç‰‡æ’­æ”¾å™¨ä¸€æ¨£çš„æ»¿ç‰ˆæ•ˆæœ */
        .arcade-screen-container.fullscreen-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
            
            border: none !important;
            border-radius: 0 !important;
            margin: 0 !important;
            z-index: 99999 !important;
            background: #000 !important;
            box-shadow: none !important;
            
            /* é©é…ç€æµ·ï¼Œé¿å…å…§å®¹è¢«åˆ‡æ‰ï¼Œä½†èƒŒæ™¯ä¿æŒæ»¿ç‰ˆ */
            padding-top: var(--sat);
            padding-bottom: var(--sab);
            padding-left: var(--sal);
            padding-right: var(--sar);
        }

        /* ç•¶é€²å…¥å…¨è¢å¹•æ¨¡å¼æ™‚ï¼Œé¡¯ç¤ºæ‡¸æµ®é€€å‡ºæŒ‰éˆ• */
        .fullscreen-mode #floating-exit-btn {
            display: flex !important;
        }

        /* é‡å°æ©«å±ï¼šå¦‚æœéŠæˆ²æ­£åœ¨é‹è¡Œï¼Œè‡ªå‹•å¥—ç”¨å…¨è¢å¹•æ¨£å¼ */
        @media (orientation: landscape) and (max-width: 900px) {
            .game-running .arcade-screen-container {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100% !important;
                height: 100% !important;
                
                z-index: 99999 !important;
                border-radius: 0 !important;
                border: none !important;
                background: #000 !important;
                
                /* ç¢ºä¿æ©«å±æ™‚å·¦å³æœ‰å®‰å…¨è·é›¢ */
                padding-left: var(--sal);
                padding-right: var(--sar);
            }
            
            /* æ©«å±å…¨è¢å¹•æ™‚ï¼Œéš±è—ç¶²é å…¶ä»–éƒ¨åˆ†ï¼Œé¿å…å¹²æ“¾ */
            .game-running header, 
            .game-running .control-panel, 
            .game-running footer {
                display: none !important;
            }

            /* æ©«å±å…¨è¢å¹•æ™‚ï¼Œå¼·åˆ¶ body ä¸å¯æ»¾å‹• */
            .game-running body {
                overflow: hidden !important;
                background-color: #000 !important; /* è®“èƒŒæ™¯å…¨é»‘ï¼Œé¿å…æ»‘å‹•æ™‚çœ‹åˆ°ç¸«éš™ */
            }

            /* æ©«å±è‡ªå‹•å…¨è¢å¹•æ™‚ä¹Ÿè¦é¡¯ç¤ºé€€å‡ºæŒ‰éˆ• */
            .game-running #floating-exit-btn {
                display: flex !important;
            }
        }

        /* æ‰‹å‹•å…¨è¢å¹•æ™‚ä¹Ÿè¦é–å®š body æ»¾å‹• */
        body.lock-scroll {
            overflow: hidden !important;
        }

        @media (min-width: 768px) {
            .arcade-screen-container {
                border: 20px solid #333;
                border-bottom-width: 40px;
                border-radius: 10px;
                min-height: 500px;
                aspect-ratio: auto;
            }
        }

        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 20;
        }

        #game {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
        }

        /* æ‡¸æµ®é€€å‡ºæŒ‰éˆ•æ¨£å¼ - å„ªåŒ–ç‰ˆ */
        #floating-exit-btn {
            display: none; /* é è¨­éš±è— */
            position: absolute;
            
            /* æ”¹ç‚ºå³ä¸Šè§’ï¼Œä¸¦ä½¿ç”¨ max å‡½æ•¸ç¢ºä¿ä¸æœƒè²¼é½Šè¢å¹•é‚Šç·£æˆ–è¢«ç€æµ·æ“‹ä½ */
            top: max(15px, var(--sat));
            right: max(15px, var(--sar));
            left: auto; /* å–æ¶ˆç½®ä¸­ */
            transform: none; /* å–æ¶ˆç½®ä¸­ */
            
            z-index: 100000;
            background-color: rgba(0, 0, 0, 0.5); /* æ›´ä½èª¿çš„é»‘è‰²èƒŒæ™¯ */
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-family: 'Noto Sans TC', sans-serif;
            backdrop-filter: blur(4px);
            align-items: center;
            gap: 6px;
            cursor: pointer;
            pointer-events: auto;
            
            /* é è¨­åŠé€æ˜ï¼Œé¿å…å¹²æ“¾éŠæˆ²ç•«é¢ */
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        
        /* åªæœ‰åœ¨æŒ‰ä¸‹æˆ–æ»‘é¼ ç¶“éæ™‚æ‰è®Šäº® */
        #floating-exit-btn:active, 
        #floating-exit-btn:hover {
            background-color: rgba(220, 38, 38, 0.8); /* æŒ‰ä¸‹è®Šç´… */
            opacity: 1;
            color: white;
        }

        .control-panel {
            background: #1a1a1a;
            border-top: 1px solid #333;
        }

        @media (min-width: 768px) {
            .control-panel {
                background: #222;
                border-top: 4px solid #444;
                box-shadow: inset 0 10px 20px rgba(0,0,0,0.5);
            }
        }

        input[type="file"]::file-selector-button {
            background-color: #db2777;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: bold;
            transition: background .3s;
            margin-right: 12px;
            font-size: 0.8rem;
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <header class="w-full p-3 md:p-4 bg-black/90 backdrop-blur-sm border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex flex-row justify-between items-center">
            <h1 class="text-xl md:text-3xl text-yellow-400 pixel-font tracking-tighter truncate">
                ARCADE<span class="text-pink-500">EMU</span>
            </h1>
            <button id="fullscreen-btn" class="md:hidden bg-gray-800 text-white px-3 py-1 rounded border border-gray-600 text-xs shadow-lg active:bg-gray-700">
                å…¨è¢å¹•æ¨¡å¼
            </button>
        </div>
    </header>

    <main class="w-full max-w-5xl p-2 md:p-4 flex-grow flex flex-col gap-4">
        
        <!-- è¢å¹•å®¹å™¨ -->
        <div class="w-full arcade-screen-container relative group" id="screen-wrapper">
            <!-- æƒæç·šç‰¹æ•ˆ -->
            <div class="scanlines opacity-50 pointer-events-none"></div>

            <!-- æ‡¸æµ®é€€å‡ºæŒ‰éˆ• (å…¨è¢å¹•æ™‚é¡¯ç¤º) -->
            <button id="floating-exit-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                é€€å‡ºå…¨è¢å¹•
            </button>
            
            <!-- åˆå§‹æç¤ºç•«é¢ -->
            <div id="placeholder-screen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-4 z-30 bg-black/90">
                <div class="mb-4 md:mb-6 animate-pulse text-gray-600">
                    <svg class="w-16 h-16 md:w-24 md:h-24 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="text-lg md:text-2xl font-bold text-white mb-2">æº–å‚™é–‹å§‹éŠæˆ²</h2>
                <div class="text-sm text-gray-400 mb-4 max-w-md">
                    <p>è«‹é¸æ“‡ä¸‹æ–¹ <span class="text-yellow-400">å…§å»ºéŠæˆ²</span> æˆ– <span class="text-pink-400">ä¸Šå‚³æª”æ¡ˆ</span></p>
                    <p class="text-xs mt-2 text-yellow-500">
                        æç¤ºï¼šéŠæˆ²å•Ÿå‹•å¾Œï¼Œæ‰‹æ©Ÿ<span class="font-bold text-white">è½‰æ©«</span>å¯è‡ªå‹•å…¨è¢å¹•éŠç©ã€‚
                    </p>
                </div>
                <div class="text-xs md:text-sm text-gray-500 border border-gray-700 p-2 rounded bg-black/50 w-full max-w-sm overflow-hidden text-ellipsis whitespace-nowrap">
                    ç‹€æ…‹: <span id="status-text">ç­‰å¾…é¸æ“‡...</span>
                </div>
            </div>

            <div id="game"></div>
        </div>

        <div class="control-panel rounded-lg p-4 md:p-6 w-full text-white mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                
                <!-- éŠæˆ²ä¾†æºé¸æ“‡å€ -->
                <div class="space-y-4">
                    <label class="block text-xs md:text-sm font-bold text-yellow-400 uppercase tracking-wider">
                        1. é¸æ“‡éŠæˆ² (Game Source)
                    </label>
                    
                    <!-- æ–¹å¼ A: ä¼ºæœå™¨åˆ—è¡¨ -->
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                        <label class="block text-xs text-gray-400 mb-2">A. é¸æ“‡å…§å»ºéŠæˆ² (Server ROMs)</label>
                        <select id="server-rom-select" class="bg-gray-900 text-white border border-gray-600 text-sm rounded-lg focus:ring-yellow-500 focus:border-yellow-500 block w-full p-2.5">
                            <option value="">-- è«‹é¸æ“‡ (å·²ä¸Šå‚³è‡³ä¼ºæœå™¨) --</option>
                            <!-- JS æœƒè‡ªå‹•å¡«å…¥é¸é … -->
                        </select>
                        <!-- æ–°å¢ï¼šæç¤ºæ–‡å­— -->
                        <p class="text-[10px] text-gray-500 mt-2 ml-1">
                            * æ³¨æ„ï¼šåˆ—è¡¨ä¸­çš„éŠæˆ²éœ€ç¢ºèªå·²å°‡å°æ‡‰çš„ <span class="font-mono text-yellow-500 bg-gray-900 px-1 rounded">.zip</span> æª”ä¸Šå‚³è‡³ç¶²ç«™æ ¹ç›®éŒ„ã€‚
                        </p>
                    </div>

                    <div class="relative flex py-1 items-center">
                        <div class="flex-grow border-t border-gray-700"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-600 text-xs">æˆ–æ˜¯ (OR)</span>
                        <div class="flex-grow border-t border-gray-700"></div>
                    </div>

                    <!-- æ–¹å¼ B: æœ¬åœ°ä¸Šå‚³ -->
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                        <label class="block text-xs text-gray-400 mb-2">B. ä¸Šå‚³æœ¬åœ°æª”æ¡ˆ (Local Upload)</label>
                        <input type="file" id="rom-upload" accept=".zip,.7z,.nes,.sfc,.smc,.bin,.md,.gba" class="block w-full text-xs text-gray-400
                            file:bg-pink-700 file:text-white
                            hover:file:bg-pink-600
                        "/>
                    </div>
                </div>

                <!-- æ¨¡æ“¬å™¨è¨­å®šèˆ‡å•Ÿå‹• -->
                <div class="space-y-4">
                    <label class="block text-xs md:text-sm font-bold text-cyan-400 uppercase tracking-wider">
                        2. å•Ÿå‹•è¨­å®š (Settings)
                    </label>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">æ¨¡æ“¬å™¨æ ¸å¿ƒ (Core)</label>
                            <select id="core-select" class="bg-gray-800 text-white border border-gray-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <optgroup label="è¡—æ©Ÿ (Arcade)">
                                    <option value="fbneo" selected>FinalBurn Neo (CPS1/2/3, NeoGeo, æ¨è–¦)</option>
                                    <option value="mame2003plus">MAME 2003 Plus (èˆŠç‰ˆè¡—æ©Ÿ)</option>
                                </optgroup>
                                <optgroup label="å®¶ç”¨æ©Ÿ (Console)">
                                    <option value="fceumm">NES (ä»»å¤©å ‚/ç´…ç™½æ©Ÿ)</option>
                                    <option value="snes9x">SNES (è¶…ç´šä»»å¤©å ‚)</option>
                                    <option value="genesis_plus_gx">Genesis (ä¸–å˜‰äº”ä»£)</option>
                                    <option value="gba">GBA (GameBoy Advance)</option>
                                </optgroup>
                            </select>
                        </div>

                        <button id="start-btn" disabled class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg disabled:opacity-30 disabled:cursor-not-allowed text-sm md:text-base flex items-center justify-center gap-2">
                            <span>å•Ÿå‹•éŠæˆ² (START)</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path></svg>
                        </button>
                    </div>

                    <div class="text-xs text-gray-500 mt-2">
                        <p id="hint-text">è«‹å…ˆé¸æ“‡éŠæˆ²ä¾†æºã€‚</p>
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œèªªæ˜ -->
            <div class="mt-6 pt-4 border-t border-gray-700 text-xs text-gray-400">
                <div class="hidden md:grid grid-cols-4 gap-4">
                    <div><span class="text-white font-bold">æŠ•å¹£ (Coin):</span> Shift</div>
                    <div><span class="text-white font-bold">é–‹å§‹ (Start):</span> Enter</div>
                    <div><span class="text-white font-bold">ç§»å‹•:</span> æ–¹å‘éµ</div>
                    <div><span class="text-white font-bold">æŒ‰éµ:</span> Z, X, A, S</div>
                </div>
                <div class="md:hidden text-center text-gray-500">
                    <p>æ‰‹æ©Ÿæ©«å‘éŠç©æ™‚ï¼Œè«‹ä½¿ç”¨è¢å¹•ä¸Šçš„è™›æ“¬æ–æ¡¿ã€‚</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        //  éŠæˆ²åˆ—è¡¨è¨­å®š
        //  æç¤ºï¼šé€™äº›æª”æ¡ˆéœ€çœŸå¯¦å­˜åœ¨æ–¼ä¼ºæœå™¨ä¸Š
        // ==========================================
        const serverGames = [
            { group: "CAPCOM ç¶“å…¸å‹•ä½œ (CPS1/CPS2)", games: [
                { name: "åé£Ÿå¤©åœ°1 (Dynasty Wars)", file: "dynwar.zip" },
                { name: "åé£Ÿå¤©åœ°2: èµ¤å£ä¹‹æˆ° (Warriors of Fate)", file: "wof.zip" },
                { name: "æé¾å¿«æ‰“ (Cadillacs and Dinosaurs)", file: "dino.zip" },
                { name: "åœ“æ¡Œæ­¦å£« (Knights of the Round)", file: "knights.zip" },
                { name: "æ‡²ç½°è€… (The Punisher)", file: "punisher.zip" },
                { name: "åå°‡ (Captain Commando)", file: "captcomm.zip" }
            ]},
            { group: "æ ¼é¬¥å¤©ç‹ (NeoGeo)", games: [
                { name: "æ ¼é¬¥å¤©ç‹ 97 (KOF '97)", file: "kof97.zip" },
                { name: "æ ¼é¬¥å¤©ç‹ 98 (KOF '98)", file: "kof98.zip" },
                { name: "æ ¼é¬¥å¤©ç‹ 2002 (KOF 2002)", file: "kof2002.zip" }
            ]},
            { group: "å¿«æ‰“æ—‹é¢¨ (Street Fighter)", games: [
                { name: "å¿«æ‰“æ—‹é¢¨ 2 (Street Fighter II)", file: "sf2.zip" },
                { name: "è¶…ç´šå¿«æ‰“æ—‹é¢¨ 2 (Super SF2)", file: "ssf2.zip" }
            ]},
            { group: "è¶Šå—å¤§æˆ° (Metal Slug)", games: [
                { name: "åˆé‡‘å½ˆé ­ 1 (Metal Slug)", file: "mslug.zip" },
                { name: "åˆé‡‘å½ˆé ­ 2 (Metal Slug 2)", file: "mslug2.zip" },
                { name: "åˆé‡‘å½ˆé ­ X (Metal Slug X)", file: "mslugx.zip" },
                { name: "åˆé‡‘å½ˆé ­ 3 (Metal Slug 3)", file: "mslug3.zip" }
            ]},
            { group: "ç¶“å…¸å°„æ“Š/å…¶ä»–", games: [
                { name: "é›ªäººå…„å¼Ÿ (Snow Bros)", file: "snowbros.zip" },
                { name: "å½©äº¬ 1945 II (Strikers 1945 II)", file: "s1945ii.zip" },
                { name: "é›·é›» (Raiden)", file: "raiden.zip" }
            ]}
        ];

        // DOM å…ƒç´ 
        const romInput = document.getElementById('rom-upload');
        const serverSelect = document.getElementById('server-rom-select');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const hintText = document.getElementById('hint-text');
        const placeholderScreen = document.getElementById('placeholder-screen');
        const coreSelect = document.getElementById('core-select');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const screenWrapper = document.getElementById('screen-wrapper');
        const floatingExitBtn = document.getElementById('floating-exit-btn');

        // ç‹€æ…‹è®Šæ•¸
        let gameUrl = null;
        let emulatorScriptLoaded = false;

        // åˆå§‹åŒ–ï¼šç”¢ç”Ÿå…§å»ºéŠæˆ²é¸å–® (æ”¯æ´åˆ†çµ„)
        function initServerGames() {
            serverGames.forEach(group => {
                const optgroup = document.createElement('optgroup');
                // æ–°å¢ï¼šåœ¨ç¾¤çµ„æ¨™ç±¤ä¸Šæ¨™è¨»éœ€ä¸Šå‚³
                optgroup.label = `ğŸ“‚ ${group.group} (éœ€å°‡æª”æ¡ˆä¸Šå‚³è‡³ä¼ºæœå™¨)`;
                group.games.forEach(game => {
                    const option = document.createElement('option');
                    option.value = game.file;
                    option.textContent = game.name;
                    optgroup.appendChild(option);
                });
                serverSelect.appendChild(optgroup);
            });
        }
        initServerGames();

        // --- æ ¸å¿ƒæ™ºæ…§åˆ¤æ–·é‚è¼¯ ---
        function autoSelectCore(fileName) {
            const name = fileName.toLowerCase();
            let suggestedCore = 'fbneo'; // é è¨­è¡—æ©Ÿ
            let coreName = "FinalBurn Neo";

            // æ ¹æ“šå‰¯æª”ååˆ¤æ–·
            if (name.endsWith('.nes')) {
                suggestedCore = 'fceumm';
                coreName = "NES (FCEUmm)";
            } else if (name.endsWith('.sfc') || name.endsWith('.smc')) {
                suggestedCore = 'snes9x';
                coreName = "SNES (Snes9x)";
            } else if (name.endsWith('.gba')) {
                suggestedCore = 'gba';
                coreName = "GBA";
            } else if (name.endsWith('.md') || name.endsWith('.bin') || name.endsWith('.gen')) {
                suggestedCore = 'genesis_plus_gx';
                coreName = "Genesis";
            } 
            // æ ¹æ“šè¡—æ©Ÿæª”ååˆ¤æ–· (zip)
            else {
                // å¤§éƒ¨åˆ†å¸¸è¦‹è¡—æ©Ÿç”¨ fbneo æœ€å¥½ï¼Œå°‘éƒ¨åˆ†è€éŠæˆ²å¯èƒ½éœ€è¦ mame2003plus
                // é€™è£¡é è¨­ fbneoï¼Œå› ç‚ºåˆ—è¡¨ä¸­çš„éŠæˆ² (CPS, NeoGeo) éƒ½æ˜¯ fbneo å¼·é …
                suggestedCore = 'fbneo';
                coreName = "FinalBurn Neo";
            }

            // æ›´æ–° UI
            coreSelect.value = suggestedCore;
            hintText.innerHTML = `å·²è‡ªå‹•é¸æ“‡æ ¸å¿ƒï¼š<span class="text-green-400 font-bold">${coreName}</span>`;
            
            // åŠ å…¥ç‰¹æ•ˆæç¤º
            coreSelect.classList.add('ring-2', 'ring-green-500');
            setTimeout(() => coreSelect.classList.remove('ring-2', 'ring-green-500'), 1000);
        }

        // è™•ç†å…§å»ºéŠæˆ²é¸æ“‡
        serverSelect.addEventListener('change', (e) => {
            const selectedFile = e.target.value;
            if (selectedFile) {
                romInput.value = ''; // æ¸…é™¤æœ¬åœ°é¸æ“‡
                gameUrl = selectedFile;
                
                const selectedText = e.target.options[e.target.selectedIndex].text;
                statusText.innerText = `å·²é¸æ“‡å…§å»º: ${selectedText}`;
                statusText.className = 'text-yellow-400 font-bold';
                
                // è‡ªå‹•åˆ¤æ–·æ ¸å¿ƒ
                autoSelectCore(selectedFile);
                startBtn.disabled = false;
            } else {
                resetSelection();
            }
        });

        // è™•ç†æœ¬åœ°æª”æ¡ˆä¸Šå‚³
        romInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                serverSelect.value = ""; // æ¸…é™¤å…§å»ºé¸æ“‡
                gameUrl = URL.createObjectURL(file);
                
                statusText.innerText = `å·²è¼‰å…¥æœ¬åœ°: ${file.name}`;
                statusText.className = 'text-pink-400 font-bold';
                
                // è‡ªå‹•åˆ¤æ–·æ ¸å¿ƒ
                autoSelectCore(file.name);
                startBtn.disabled = false;
            } else {
                resetSelection();
            }
        });

        function resetSelection() {
            gameUrl = null;
            startBtn.disabled = true;
            statusText.innerText = "ç­‰å¾…é¸æ“‡...";
            statusText.className = "";
            hintText.innerText = "è«‹é¸æ“‡éŠæˆ²ä¾†æºã€‚";
        }

        // å•Ÿå‹•æ¨¡æ“¬å™¨
        startBtn.addEventListener('click', function() {
            if (!gameUrl) return;

            // æ¨™è¨˜éŠæˆ²æ­£åœ¨é‹è¡Œ
            document.body.classList.add('game-running');
            
            // å•Ÿå‹•æ™‚ä¹Ÿå¼·åˆ¶é–å®šæ²å‹• (å¦‚æœé€²å…¥æ‰‹å‹•å…¨è¢å¹•)
            // checkOrientationAndFullscreen ç¨å¾Œæœƒè™•ç†æ©«å±çš„ç‹€æ…‹

            placeholderScreen.style.display = 'none';
            statusText.innerText = "æ­£åœ¨å•Ÿå‹•...";

            const selectedCore = coreSelect.value;
            
            window.EJS_player = '#game';
            window.EJS_core = selectedCore; 
            window.EJS_gameUrl = gameUrl;
            window.EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';
            
            if (!emulatorScriptLoaded) {
                const script = document.createElement('script');
                script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
                script.async = true;
                script.onload = () => {
                    emulatorScriptLoaded = true;
                    console.log("EmulatorJS Core Loaded");
                };
                document.body.appendChild(script);
            } else {
                if(confirm("åˆ‡æ›éŠæˆ²å»ºè­°é‡æ–°æ•´ç†é é¢ä»¥é¿å…éŒ¯èª¤ã€‚æ˜¯å¦åˆ·æ–°é é¢ï¼Ÿ")) {
                    location.reload();
                } else {
                     try { window.EJS_Emulator.destroy(); } catch(e){}
                }
            }
        });

        // --- å…¨è¢å¹•èˆ‡æ–¹å‘æ§åˆ¶é‚è¼¯ ---

        // é€²å…¥å…¨è¢å¹• (æ‰‹å‹•æˆ–è‡ªå‹•)
        function enterFullscreen() {
            screenWrapper.classList.add('fullscreen-mode');
            fullscreenBtn.innerText = "é€€å‡ºå…¨è¢å¹•";
            fullscreenBtn.classList.add('bg-red-600');
            document.body.classList.add('lock-scroll'); // é–å®šæ²å‹•
            
            // å˜—è©¦åŸç”Ÿå…¨è¢å¹• API (Android/Desktop)
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
            
            // å¼·åˆ¶é‡ç¹ª Canvas ä»¥é©é…æ–°å°ºå¯¸
            setTimeout(() => {
                 if(window.dispatchEvent) window.dispatchEvent(new Event('resize'));
            }, 300);
        }

        // é€€å‡ºå…¨è¢å¹•
        function exitFullscreen() {
            screenWrapper.classList.remove('fullscreen-mode');
            fullscreenBtn.innerText = "å…¨è¢å¹•æ¨¡å¼";
            fullscreenBtn.classList.remove('bg-red-600');
            
            // åªæœ‰åœ¨éæ©«å±è‡ªå‹•æ¨¡å¼ä¸‹æ‰ç§»é™¤é–å®š
            // (å¦‚æœæ˜¯æ©«å±ç‹€æ…‹ï¼ŒCSS æœƒå¼·åˆ¶éš±è—æ²å‹•ï¼Œé€™è£¡ JS ç§»é™¤é¡åˆ¥ä¸å½±éŸ¿æ©«å±çš„ CSS è¦å‰‡)
            document.body.classList.remove('lock-scroll');

            if (document.exitFullscreen) {
                document.exitFullscreen().catch(() => {});
            }
            
            // å¼·åˆ¶é‡ç¹ª
            setTimeout(() => {
                 if(window.dispatchEvent) window.dispatchEvent(new Event('resize'));
            }, 300);
        }

        // æ‡¸æµ®æŒ‰éˆ•ï¼šé»æ“Šå¾Œé€€å‡ºå…¨è¢å¹•
        floatingExitBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢é»æ“Šç©¿é€
            
            // å¦‚æœæ˜¯æ©«å±è‡ªå‹•å…¨è¢å¹•ï¼Œé€™æ™‚å€™é€€å‡ºæ„å‘³è‘—æˆ‘å€‘å¯èƒ½æƒ³è¦æš«æ™‚çœ‹ä¸‹ç¶²é å…¶ä»–å…§å®¹
            // ä½†å› ç‚ºæ©«å± CSS æ˜¯å¯«æ­»çš„ (media query)ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹æ–¹æ³•æš«æ™‚æ‰“ç ´å®ƒ
            // é€™è£¡ç°¡å–®è™•ç†ï¼šç›´æ¥å‘¼å« exitFullscreen() å»é™¤ fullscreen-mode class
            // å°æ–¼æ©«å±è‡ªå‹•å…¨è¢å¹•ï¼Œæˆ‘å€‘éœ€è¦ç§»é™¤ 'game-running' class æ‰èƒ½æ¢å¾©é¡¯ç¤ºå…¶ä»– UI?
            // ä¸ï¼Œä½¿ç”¨è€…é€šå¸¸æ˜¯æƒ³èª¿æ•´è¨­å®šæˆ–æ›éŠæˆ²ã€‚
            
            // ç­–ç•¥ï¼šå¦‚æœæ˜¯åœ¨æ©«å±æ¨¡å¼ä¸‹é»æ“Šé€€å‡ºï¼Œæˆ‘å€‘ç§»é™¤ 'game-running' ç‹€æ…‹ä¾†é¡¯ç¤º Header/Footer
            // ä½†é€™æ¨£æœƒåœæ­¢è‡ªå‹•å…¨è¢å¹•æ•ˆæœã€‚
            
            if (window.innerWidth > window.innerHeight) {
                 // æ©«å±æ™‚ï¼Œæš«æ™‚ç§»é™¤éŠæˆ²é‹è¡Œç‹€æ…‹æ¨™è¨˜ï¼Œè®“ UI å›ä¾†
                 // æ³¨æ„ï¼šé€™ä¸æœƒé—œé–‰éŠæˆ²ï¼Œåªæ˜¯è®“ CSS media query å¤±æ•ˆ
                 if(document.body.classList.contains('game-running')) {
                     // æç¤ºç”¨æˆ¶ï¼šé€™æœƒå›åˆ°æ­£å¸¸ç¶²é è¦–åœ–
                     document.body.classList.remove('game-running');
                 }
            }
            
            exitFullscreen();
        });

        // é ‚éƒ¨æŒ‰éˆ• (æ‰‹å‹•åˆ‡æ›)
        fullscreenBtn.addEventListener('click', () => {
            if (screenWrapper.classList.contains('fullscreen-mode')) {
                exitFullscreen();
            } else {
                enterFullscreen();
            }
        });
        
        // ç›£è½è¢å¹•æ—‹è½‰/èª¿æ•´å¤§å°
        window.addEventListener('resize', () => {
             // ç¢ºä¿å°ºå¯¸è®ŠåŒ–æ™‚é€šçŸ¥æ¨¡æ“¬å™¨é‡ç¹ª
             // EmulatorJS å…§éƒ¨é€šå¸¸æœƒç›£è½ resizeï¼Œä½†æœ‰æ™‚å€™ CSS transition æœƒå°è‡´æ™‚åºå•é¡Œ
        });

        // æ‹–æ”¾é˜²èª¤è§¸
        window.addEventListener('dragover', (e) => e.preventDefault());
        window.addEventListener('drop', (e) => e.preventDefault());

    </script>
</body>
</html>